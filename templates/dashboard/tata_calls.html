{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}TATA Call Records - BOP Realty{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .call-record {
        border-left: 4px solid #667eea;
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    
    .call-record:hover {
        background: #e2e8f0;
        transform: translateX(5px);
    }
    
    .call-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-answered { background: #dcfce7; color: #166534; }
    .status-missed { background: #fee2e2; color: #991b1b; }
    .status-busy { background: #fef3c7; color: #92400e; }
    
    .recording-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.8rem;
    }
    
    .active-call {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">
            <i class="fas fa-phone text-primary me-2"></i>TATA Call Records & Analytics
        </h4>
        <small class="text-muted">Real-time call data from TATA panel</small>
    </div>
    
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-primary btn-sm" onclick="exportData()">
            <i class="fas fa-download"></i> Export
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" name="from_date" value="{{ from_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" name="to_date" value="{{ to_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Call Type</label>
                <select class="form-select" name="call_type">
                    <option value="">All Types</option>
                    <option value="inbound" {% if call_type == 'inbound' %}selected{% endif %}>Inbound</option>
                    <option value="outbound" {% if call_type == 'outbound' %}selected{% endif %}>Outbound</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Analytics Cards -->
{% if analytics.success %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <h3 class="mb-0">{{ analytics.analytics.total_calls }}</h3>
            <small>Total Calls</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h3 class="mb-0">{{ analytics.analytics.answered_calls }}</h3>
            <small>Answered Calls</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h3 class="mb-0">{{ analytics.analytics.answer_rate|floatformat:1 }}%</h3>
            <small>Answer Rate</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h3 class="mb-0">{{ analytics.analytics.avg_duration_seconds|floatformat:0 }}s</h3>
            <small>Avg Duration</small>
        </div>
    </div>
</div>
{% endif %}

<!-- Active Calls -->
{% if active_calls.success and active_calls.data %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-phone-alt text-danger me-2"></i>Active Calls ({{ active_calls.data|length }})
        </h5>
    </div>
    <div class="card-body">
        {% for call in active_calls.data %}
        <div class="active-call">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ call.customer_number }}</strong>
                    <span class="ms-2">â†’ {{ call.agent_name|default:"Unknown Agent" }}</span>
                </div>
                <div>
                    <span class="badge bg-light text-dark">{{ call.call_time }}</span>
                    <span class="badge bg-success ms-1">{{ call.state }}</span>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted mb-0">No active calls</p>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- TATA API Call Records -->
{% if api_calls.results %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list text-primary me-2"></i>TATA Call Records ({{ api_calls.count }} total)
        </h5>
    </div>
    <div class="card-body">
        {% for call in api_calls.results %}
        <div class="call-record">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>{{ call.client_number }}</strong>
                    <br><small class="text-muted">{{ call.date }} {{ call.time }}</small>
                </div>
                <div class="col-md-2">
                    <span class="call-status status-{{ call.status }}">
                        {{ call.status|title }}
                    </span>
                </div>
                <div class="col-md-2">
                    <i class="fas fa-clock text-muted me-1"></i>
                    {{ call.call_duration }}s
                </div>
                <div class="col-md-2">
                    <i class="fas fa-user text-muted me-1"></i>
                    {{ call.agent_name|default:"No Agent" }}
                </div>
                <div class="col-md-3 text-end">
                    {% if call.recording_url %}
                    <button class="recording-btn" onclick="playRecording('{{ call.recording_url }}')">
                        <i class="fas fa-play me-1"></i>Play Recording
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-secondary btn-sm ms-1" onclick="viewCallDetails({{ call|safe }})">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">No call records found</p>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Local Call Logs -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-database text-secondary me-2"></i>Local Call Logs
        </h5>
    </div>
    <div class="card-body">
        {% for call in call_logs %}
        <div class="call-record">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <strong>{{ call.caller_id_number }}</strong>
                    <br><small class="text-muted">{{ call.start_stamp|date:"M d, Y H:i" }}</small>
                </div>
                <div class="col-md-2">
                    <span class="call-status status-{{ call.status }}">
                        {{ call.status|title }}
                    </span>
                </div>
                <div class="col-md-2">
                    <i class="fas fa-clock text-muted me-1"></i>
                    {{ call.duration }}s
                </div>
                <div class="col-md-4">
                    {% if call.associated_lead %}
                    <a href="{% url 'view_lead' call.associated_lead.id %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user me-1"></i>{{ call.associated_lead.name }}
                    </a>
                    {% else %}
                    <span class="text-muted">No lead associated</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">No local call logs found</p>
        {% endfor %}
        
        <!-- Pagination -->
        {% if call_logs.has_other_pages %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                {% if call_logs.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ call_logs.previous_page_number }}">Previous</a>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">{{ call_logs.number }} of {{ call_logs.paginator.num_pages }}</span>
                </li>
                
                {% if call_logs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ call_logs.next_page_number }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Call Details Modal -->
<div class="modal fade" id="callDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Call Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="callDetailsContent">
                <!-- Call details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Recording Player Modal -->
<div class="modal fade" id="recordingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Call Recording</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <audio id="recordingPlayer" controls style="width: 100%;">
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshData() {
    window.location.reload();
}

function exportData() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.open(`${window.location.pathname}?${params.toString()}`);
}

function playRecording(url) {
    const player = document.getElementById('recordingPlayer');
    player.src = url;
    const modal = new bootstrap.Modal(document.getElementById('recordingModal'));
    modal.show();
}

function viewCallDetails(call) {
    const content = document.getElementById('callDetailsContent');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Call Information</h6>
                <table class="table table-sm">
                    <tr><th>Call ID:</th><td>${call.call_id}</td></tr>
                    <tr><th>Direction:</th><td>${call.direction}</td></tr>
                    <tr><th>Status:</th><td>${call.status}</td></tr>
                    <tr><th>Duration:</th><td>${call.call_duration} seconds</td></tr>
                    <tr><th>Date:</th><td>${call.date} ${call.time}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Participants</h6>
                <table class="table table-sm">
                    <tr><th>Customer:</th><td>${call.client_number}</td></tr>
                    <tr><th>Agent:</th><td>${call.agent_name || 'N/A'}</td></tr>
                    <tr><th>DID Number:</th><td>${call.did_number}</td></tr>
                </table>
            </div>
        </div>
        
        ${call.call_flow ? `
        <div class="mt-3">
            <h6>Call Flow</h6>
            <div class="timeline">
                ${call.call_flow.map(flow => `
                    <div class="timeline-item">
                        <small class="text-muted">${flow.readableTime}</small>
                        <div>${flow.type}: ${flow.value || flow.name || 'Event'}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('callDetailsModal'));
    modal.show();
}

// Auto-refresh active calls every 30 seconds
setInterval(() => {
    if (document.querySelector('.active-call')) {
        fetch(window.location.href, {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.text())
        .then(html => {
            // Update only active calls section
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newActiveCalls = doc.querySelector('.active-calls-section');
            if (newActiveCalls) {
                document.querySelector('.active-calls-section').innerHTML = newActiveCalls.innerHTML;
            }
        })
        .catch(console.error);
    }
}, 30000);
</script>
{% endblock %}